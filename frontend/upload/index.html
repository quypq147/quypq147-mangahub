<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Contributor Dashboard - MangaHub</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#3b82f6",
                        "background-light": "#f3f4f6",
                        "background-dark": "#111827",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1f2937",
                        "card-dark": "#1a2234",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.5rem",
                    },
                },
            },
        };
    </script>
    <script>
        // --- 0. DANH SÁCH THỂ LOẠI CÓ SẴN ---
        const PREDEFINED_GENRES = [
            "Hành Động", "Tình Cảm", "Học Đường", "Hài Hước",
            "Phiêu Lưu", "Kinh Dị", "Đời Thường", "Phép Thuật",
            "Thể Thao", "Viễn Tưởng", "Trinh Thám", "Mecha",
            "Xuyên Không", "Cổ Trang", "Trùng Sinh", "Harem", "Yuri" , "Incest"
        ];

        // Hàm khởi tạo các nút thể loại
        function renderGenreTags() {
            const container = document.getElementById('genre-container');
            const hiddenInputs = document.getElementById('hidden-genre-inputs');

            container.innerHTML = '';
            hiddenInputs.innerHTML = '';

            PREDEFINED_GENRES.forEach(genre => {
                const genreKey = encodeURIComponent(genre);
                // 1. Tạo nút Tag hiển thị
                const tag = document.createElement('button');
                tag.type = 'button'; // Quan trọng: để không submit form khi bấm
                tag.className = "px-3 py-1.5 text-sm rounded-full border transition-all duration-200 select-none bg-slate-100 text-slate-600 border-slate-300 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700";
                tag.innerText = genre;

                // 2. Xử lý sự kiện click
                tag.onclick = () => {
                    // Đổi trạng thái hiển thị (Toggle class)
                    const isActive = tag.classList.contains('bg-primary');

                    if (!isActive) {
                        // Chọn: Đổi màu xanh + Chữ trắng
                        tag.className = "px-3 py-1.5 text-sm rounded-full border transition-all duration-200 select-none bg-primary text-white border-primary shadow-sm shadow-blue-500/30";

                        // Thêm input ẩn để gửi về server
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'genres'; // Backend sẽ nhận được mảng req.body.genres
                        input.value = genre;
                        input.id = `input-genre-${genreKey}`;
                        hiddenInputs.appendChild(input);
                    } else {
                        // Bỏ chọn: Về màu xám
                        tag.className = "px-3 py-1.5 text-sm rounded-full border transition-all duration-200 select-none bg-slate-100 text-slate-600 border-slate-300 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700";

                        // Xóa input ẩn
                        const input = document.getElementById(`input-genre-${genreKey}`);
                        if (input) input.remove();
                    }
                };

                container.appendChild(tag);
            });
        }

        // Gọi hàm này khi trang vừa tải xong
        document.addEventListener("DOMContentLoaded", () => {
            renderGenreTags();
            loadMangaOptions(); // Hàm cũ của bạn
        });
    </script>
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen transition-colors duration-200">
    <script>window.NAV_BASE_PATH = '../';</script>
    <div id="site-nav"></div>
    <main class="max-w-5xl mx-auto px-4 py-8">
        <div class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Contributor Dashboard</h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">Manage your series and content uploads</p>
            </div>
            <a class="inline-flex items-center text-primary hover:underline text-sm font-medium" href="../index.html">
                <span class="material-symbols-outlined text-[18px] mr-1">arrow_back</span>
                Quay lại trang chính
            </a>
        </div>
        <div class="flex border-b border-slate-200 dark:border-slate-800 mb-6">
            <button id="btn-tab-series" onclick="switchTab('series')"
                class="px-6 py-3 text-sm font-semibold text-slate-500 hover:text-primary transition-colors border-b-2 border-transparent">
                Tạo manga serie mới
            </button>
            <button id="btn-tab-chapter" onclick="switchTab('chapter')"
                class="px-6 py-3 text-sm font-semibold text-primary border-b-2 border-primary transition-colors">
                Upload chương mới
            </button>
        </div>

        <div id="form-series" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div
                class="lg:col-span-2 bg-white dark:bg-card-dark rounded-xl p-6 border border-slate-200 dark:border-slate-800">
                <h2 class="text-xl font-bold mb-4">New Series Details</h2>
                <form id="create-manga-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Tiêu đề manga</label>
                        <input type="text" name="title" required
                            class="w-full rounded-md border-slate-300 dark:bg-slate-900" placeholder="e.g. One Piece">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tác giả</label>
                        <input type="text" name="author" required
                            class="w-full rounded-md border-slate-300 dark:bg-slate-900"
                            placeholder="e.g. Eiichiro Oda">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Mô tả</label>
                        <input type="text" name="description" required
                            class="w-full rounded-md border-slate-300 dark:bg-slate-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Thể loại (Chọn nhiều)</label>

                        <div id="genre-container" class="flex flex-wrap gap-2">
                        </div>

                        <div id="hidden-genre-inputs"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Ảnh bìa (Cover Image)</label>
                        <input type="file" name="coverImage" accept="image/*" required
                            class="w-full rounded-md border border-slate-300 dark:border-slate-700 p-2 dark:bg-slate-900 text-sm">
                        <p class="text-xs text-slate-500 mt-1">Hỗ trợ JPG, PNG, WEBP.</p>
                    </div>
                    <button type="submit"
                        class="px-6 py-2 bg-primary text-white rounded-lg font-bold hover:bg-blue-600">
                        Tạo truyện mới
                    </button>
                </form>
            </div>
        </div>

        <div id="form-chapter" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div
                    class="bg-white dark:bg-card-dark rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6">
                    <form id="upload-chapter-form" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Manga Series</label>
                            <select id="manga-select" name="mangaId"
                                class="block w-full rounded-md border-slate-300 dark:bg-[#111827]">
                                <option value="">Đang tải danh sách...</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Số chương</label>
                                <input type="number" name="chapterNumber" required
                                    class="block w-full rounded-md border-slate-300 dark:bg-[#111827]">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Tiêu đề (Tùy chọn)</label>
                                <input type="text" name="title"
                                    class="block w-full rounded-md border-slate-300 dark:bg-[#111827]">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Trang truyện</label>
                            <div
                                class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center bg-slate-50 dark:bg-[#111827]/50">
                                <input type="file" name="pages" multiple accept="image/*" class="w-full" required />
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit"
                                class="px-8 py-2.5 bg-primary text-white font-bold rounded-lg shadow-lg hover:bg-blue-600">
                                Tải lên chương
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    <script src="../assets/js/config.js"></script>
    <script>

        // --- 1. TAB SWITCHING LOGIC ---
        function switchTab(tab) {
            const seriesForm = document.getElementById('form-series');
            const chapterForm = document.getElementById('form-chapter');
            const btnSeries = document.getElementById('btn-tab-series');
            const btnChapter = document.getElementById('btn-tab-chapter');

            if (tab === 'series') {
                seriesForm.classList.remove('hidden');
                chapterForm.classList.add('hidden');

                // Update Styles
                btnSeries.classList.add('text-primary', 'border-primary');
                btnSeries.classList.remove('text-slate-500', 'border-transparent');
                btnChapter.classList.remove('text-primary', 'border-primary');
                btnChapter.classList.add('text-slate-500', 'border-transparent');
            } else {
                seriesForm.classList.add('hidden');
                chapterForm.classList.remove('hidden');

                // Update Styles
                btnChapter.classList.add('text-primary', 'border-primary');
                btnChapter.classList.remove('text-slate-500', 'border-transparent');
                btnSeries.classList.remove('text-primary', 'border-primary');
                btnSeries.classList.add('text-slate-500', 'border-transparent');

                // Reload manga list when switching to upload tab
                loadMangaOptions();
            }
        }

        // --- 2. LOAD MANGA FOR DROPDOWN ---
        async function loadMangaOptions() {
            try {
                const res = await fetch(`${API_BASE}/manga`);
                const mangas = await res.json();

                const select = document.getElementById('manga-select');
                select.innerHTML = '<option value="">Select a series</option>';

                mangas.forEach(manga => {
                    const option = document.createElement('option');
                    option.value = manga._id;
                    option.text = manga.title;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error("Error loading manga:", err);
            }
        }

        // --- 3. HANDLE CREATE MANGA SUBMIT (WITH FILE UPLOAD) ---
        document.getElementById('create-manga-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target); // includes coverImage file

            try {
                const res = await fetch(`${API_BASE}/manga`, {
                    method: 'POST',
                    body: formData // let browser set multipart/form-data
                });

                let result = null;
                try {
                    result = await res.json();
                } catch (_) { }

                if (res.ok) {
                    alert("Đã tạo series thành công!");
                    e.target.reset();
                    loadMangaOptions();
                } else {
                    const msg = result && result.error ? result.error : "Lỗi tạo series";
                    alert(msg);
                }
            } catch (err) {
                console.error(err);
                alert("Lỗi server");
            }
        });

        // --- 4. HANDLE UPLOAD CHAPTER SUBMIT ---
        document.getElementById('upload-chapter-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target); // Automatically grabs files and inputs

            // Simple validation
            if (!formData.get('mangaId')) {
                alert("Please select a manga series");
                return;
            }

            try {
                // Note: No 'Content-Type' header needed; fetch sets it automatically for FormData (multipart)
                const res = await fetch(`${API_BASE}/chapters`, {
                    method: 'POST',
                    body: formData
                });

                const result = await res.json();
                if (res.ok) {
                    alert("Da upload chuong thanh cong!");
                    e.target.reset();
                } else {
                    alert("Loi: " + result.error);
                }
            } catch (err) {
                console.error(err);
                alert("Loi Upload chuong");
            }
        });

        // Initialize
        loadMangaOptions();
    </script>
    <script src="../assets/js/nav.js"></script>
</body>

</html>

</html>